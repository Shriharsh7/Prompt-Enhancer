<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompt Enhancer</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { margin: 0; font-family: 'Arial', sans-serif; background: #F5F5F5; color: #333333; }
    .main-container { display: flex; flex: 1; height: calc(100vh - 3rem); min-height: 0; }
    .chat-section, .answer-section { flex: 1; min-width: 0; }
    .chat-container { max-height: calc(100vh - 20rem); overflow-y: auto; }
    .message-user { background: #E8F5E9; color: #2E7D32; align-self: flex-end; }
    .message-bot { background: #ECEFF1; color: #424242; align-self: flex-start; }
    .answer-box { transition: all 0.3s ease; border: 1px solid #B0BEC5; background: #FFFFFF; }
    .answer-box.loading { box-shadow: 0 0 20px rgba(46, 125, 50, 0.2); }
    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin: 0 2px;
      background-color: #2E7D32;
      border-radius: 50%;
      animation: blink 1s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 50% { opacity: 0; } }
    @media (max-width: 768px) {
      .main-container { flex-direction: column; height: auto; }
      .chat-section { border-bottom: 1px solid #B0BEC5; }
      .answer-section { border-top: none; }
      .chat-container { max-height: 50vh; }
    }
    select, textarea, button { color: #333333; background: #FFFFFF; border: 1px solid #B0BEC5; }
    select option { color: #333333; background: #FFFFFF; }
    button:not(:disabled):hover { background: #E0E0E0; }
    .placeholder-gray-400::placeholder, .placeholder-gray-500::placeholder { color: #78909C !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/framer-motion@11.0.3/dist/framer-motion.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.5/babel.min.js"></script>
  <script type="text/babel" data-presets="react">
    const { useState, useEffect, useRef } = React;
    const motion = window.FramerMotion ? window.FramerMotion.motion : null;

    const Input = ({ onSubmit, isRefinement }) => {
      const [input, setInput] = useState('');
      const textareaRef = useRef(null);

      useEffect(() => {
        const ta = textareaRef.current;
        if (ta) {
          ta.style.height = 'auto';
          ta.style.height = ta.scrollHeight + 'px';
        }
      }, [input]);

      const handleSubmit = () => {
        if (!input.trim()) return;
        onSubmit(input);
        setInput('');
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSubmit();
        }
      };

      return (
        <div className="mt-4 border-t pt-4 border-gray-300">
          <textarea
            ref={textareaRef}
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyPress={handleKeyPress}
            placeholder={isRefinement ? 'Add more context or refinement...' : 'Enter your rough idea...'}
            className="w-full p-2 rounded border resize-none overflow-hidden text-sm bg-white border-gray-300 placeholder-gray-500"
            rows="2"
          />
          <button
            onClick={handleSubmit}
            className={`mt-2 p-2 bg-green-600 text-white rounded w-full text-sm font-medium transition-colors ${!input.trim() ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-700'}`}
            disabled={!input.trim()}
          >
            {isRefinement ? 'Refine Prompt' : 'Generate Prompt'}
          </button>
        </div>
      );
    };

    const App = () => {
      const [conversation, setConversation] = useState([]);
      const [generatedPrompt, setGeneratedPrompt] = useState('');
      const [answer, setAnswer] = useState('');
      const [isLoadingPrompt, setIsLoadingPrompt] = useState(false);
      const [isLoadingAnswer, setIsLoadingAnswer] = useState(false);
      const [template, setTemplate] = useState('general');
      const chatEndRef = useRef(null);

      const templates = ['general', 'research', 'creative', 'tech', 'technical_tutorial', 'business_case_study', 'narrative_essay', 'code_documentation'];

      useEffect(() => {
        chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
      }, [conversation, isLoadingPrompt]);

      const handleGeneratePrompt = async (input) => {
        if (!input.trim()) return;

        const isRefinement = conversation.some(msg => msg.type === 'bot');
        const newUserMsg = { type: 'user', text: input };

        if (!isRefinement) setConversation(prev => [...prev, newUserMsg]);
        else console.log("Refinement input:", input);

        setIsLoadingPrompt(true);
        setGeneratedPrompt('');
        setAnswer('');

        try {
          const endpoint = isRefinement ? '/refine' : '/generate';
          const currentBotPrompt = conversation.find(msg => msg.type === 'bot')?.text || '';
          const body = isRefinement
            ? {
                prompt: currentBotPrompt,
                additional_input: input,
                refinement_count: conversation.filter(msg => msg.type === 'bot').length,
                choice: 'add_context' // âœ… FIXED: Required field for backend refine
              }
            : { prompt: input, template };

          console.log("Sending to backend:", endpoint, body);

          const generateRes = await fetch('http://localhost:8000' + endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });

          if (!generateRes.ok) throw new Error(`Failed to ${isRefinement ? 'refine' : 'generate'} prompt: ${await generateRes.text()}`);

          const data = await generateRes.json();
          const newPrompt = data.prompt || data.refined_prompt;

          if (!newPrompt) throw new Error("Backend did not return a valid prompt.");

          setConversation(prev => {
            if (isRefinement) {
              const lastBotIndex = prev.map(m => m.type).lastIndexOf('bot');
              if (lastBotIndex !== -1) {
                const updated = [...prev];
                updated[lastBotIndex] = { type: 'bot', text: newPrompt };
                updated.splice(lastBotIndex, 0, newUserMsg);
                return updated;
              }
              return [...prev, newUserMsg, { type: 'bot', text: newPrompt }];
            }
            return [...prev, { type: 'bot', text: newPrompt }];
          });

          setGeneratedPrompt(newPrompt);
          setIsLoadingPrompt(false);
        } catch (error) {
          console.error('API error:', error);
          setConversation(prev => [...prev, { type: 'bot', text: `Error: ${error.message}` }]);
          setIsLoadingPrompt(false);
        }
      };

      const handleTestPrompt = async () => {
        if (!generatedPrompt) return;

        setIsLoadingAnswer(true);
        setAnswer('');

        try {
          const testRes = await fetch('http://localhost:8000/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: generatedPrompt }),
          });
          if (!testRes.ok) throw new Error(`Failed to test prompt: ${await testRes.text()}`);

          const testData = await testRes.json();
          setAnswer(testData.response || 'No response received from Gemini test.');
          setIsLoadingAnswer(false);
        } catch (error) {
          console.error('API error:', error);
          setAnswer(`Error occurred: ${error.message}`);
          setIsLoadingAnswer(false);
        }
      };

      const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text).catch(err => console.error('Failed to copy:', err));
      };

      const MotionDiv = motion ? motion.div : 'div';
      const motionProps = motion ? { initial: { opacity: 0, y: 10 }, animate: { opacity: 1, y: 0 }, transition: { duration: 0.3 } } : {};

      return (
        <div className="flex flex-col h-screen bg-gray-100 text-gray-800">
          <header className="p-3 bg-white text-gray-800 flex justify-between items-center shadow-md border-b border-gray-300">
            <h1 className="text-lg font-semibold">Prompt Enhancer</h1>
          </header>
          <main className="flex flex-1 overflow-hidden main-container">
            <section className="flex-1 p-4 flex flex-col border-r border-gray-300 chat-section">
              <label htmlFor="template-select" className="text-xs font-medium mb-1 text-gray-600">Prompt Style Template:</label>
              <select
                id="template-select"
                value={template}
                onChange={(e) => setTemplate(e.target.value)}
                className="w-full p-2 mb-4 rounded border bg-white text-gray-800 border-gray-300 text-sm"
                disabled={isLoadingPrompt}
              >
                {templates.map(t => <option key={t} value={t}>{t.charAt(0).toUpperCase() + t.slice(1)}</option>)}
              </select>
              <div className="flex-1 chat-container mb-4 space-y-3 pr-2">
                {conversation.map((msg, idx) => (
                  <MotionDiv
                    key={idx}
                    {...motionProps}
                    className={`max-w-[80%] w-fit p-2 px-3 rounded-lg text-sm ${msg.type === 'user' ? 'message-user ml-auto' : 'message-bot mr-auto'}`}
                  >
                    <span className="block whitespace-pre-wrap">{msg.text}</span>
                    {msg.type === 'bot' && msg.text === generatedPrompt && (
                      <button
                        onClick={() => copyToClipboard(msg.text)}
                        className="ml-2 mt-1 text-xs opacity-70 hover:opacity-100 focus:opacity-100 underline"
                        aria-label="Copy bot prompt"
                      >
                        Copy Prompt
                      </button>
                    )}
                  </MotionDiv>
                ))}
                {isLoadingPrompt && (
                  <MotionDiv {...motionProps} className="message-bot mr-auto p-2 px-3 rounded-lg text-sm">
                    <div className="typing-indicator">
                      <span></span><span></span><span></span>
                    </div>
                  </MotionDiv>
                )}
                <div ref={chatEndRef} />
              </div>
              <Input onSubmit={handleGeneratePrompt} isRefinement={conversation.some(msg => msg.type === 'bot')} />
              {generatedPrompt && !isLoadingPrompt && (
                <button
                  onClick={handleTestPrompt}
                  className="mt-2 p-2 bg-green-600 hover:bg-green-700 text-white rounded w-full text-sm font-medium transition-colors"
                >
                  Test Prompt with Gemini 2.0
                </button>
              )}
            </section>
            <section className="flex-[2] p-4 flex flex-col answer-section">
              <h2 className="text-sm font-semibold mb-2 flex-shrink-0 text-gray-600">Gemini 2.0 Test Response:</h2>
              <MotionDiv
                {...(motion ? { layout: true, initial: { opacity: 0 }, animate: { opacity: 1 } } : {})}
                className="flex-1 h-full p-4 rounded-lg border overflow-y-auto bg-white border-gray-300 answer-box"
              >
                {isLoadingAnswer ? (
                  <div className="flex items-center justify-center h-full">
                    <div className="typing-indicator text-lg">
                      <span className="bg-green-600"></span>
                      <span className="bg-green-600"></span>
                      <span className="bg-green-600"></span>
                    </div>
                  </div>
                ) : answer ? (
                  <div className="relative">
                    <pre className="text-sm whitespace-pre-wrap break-words">{answer}</pre>
                    <button
                      onClick={() => copyToClipboard(answer)}
                      className="absolute top-0 right-0 mt-1 mr-1 p-1 text-xs bg-green-600 hover:bg-green-700 text-white rounded opacity-50 hover:opacity-100 transition-opacity"
                      aria-label="Copy response"
                    >
                      Copy
                    </button>
                  </div>
                ) : (
                  <div className="flex items-center justify-center h-full text-gray-500">
                    {generatedPrompt ? 'Click "Test Prompt with Gemini 2.0" to see the response...' : 'Generate a prompt first to test it here.'}
                  </div>
                )}
              </MotionDiv>
            </section>
          </main>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
